import{ai as ee,r as c,ac as F,_ as ce,aj as ye,ak as et,al as ze,am as tt,an as V,V as S,ao as J,ap as st,aq as nt,ar as ot,as as rt,at as it,au as at,a4 as _,i as x,av as ct,aw as lt,j as d,ax as q,f as z,h as O,F as ke,ay as Ne,az as ut,l as dt,aA as Re,aB as pt,aC as ft,aD as mt,k as Ge,$ as ht,aE as W,aF as gt,aG as xt,aH as yt,aI as oe,B as be,x as bt,aJ as St,Q as wt,aK as Mt}from"./index-b7228c1a.js";import{u as ue,a as de,e as jt,m as Oe,b as C,g as pe,T as vt,L as _t,D as Ct,U as Pt,C as It}from"./constant-5225ea52.js";import{u as E,p as Et,g as At,C as Tt,S as zt,H as fe,a as kt,b as Ue,c as Nt,E as Rt,P as Gt,A as Ot,d as Ut,L as $t,e as Ft,f as Lt,V as Bt,B as Ht,R as Se,O as Wt,h as Vt}from"./EditIcon-c1e5f10e.js";import{A as qt,k as Kt}from"./react-toastify.esm-8496e00c.js";import{f as Qt,P as Xt,L as Yt}from"./constants-5b7fe868.js";import{q as $e}from"./generateCategoricalChart-f743d16e.js";import{T as Zt}from"./index-e0df4bc8.js";import{e as Jt,c as Dt}from"./index.esm-0c7d80df.js";import{P as es}from"./PlusIcon-6ab46224.js";import{P as ts,O as ss}from"./index-e29d145d.js";import"./Popover-e543ef89.js";import"./useSlotProps-fcaa0769.js";import"./InfoIcon-f4782b5c.js";import"./NoFilterResultIcon-808909d5.js";import"./index-e6a60da5.js";import"./index-0926b9e2.js";import"./index-ac6ab740.js";import"./index-155ead8e.js";import"./index-b9e4b080.js";import"./Popper-18c1587c.js";import"./CheckIcon-c3a1e1de.js";const we=e=>e===Object(e)&&!Array.isArray(e)&&typeof e!="function";function T(e,t){const p=ue(a=>a.gl),s=de(ee,we(e)?Object.values(e):e);if(c.useLayoutEffect(()=>{t==null||t(s)},[t]),c.useEffect(()=>{(Array.isArray(s)?s:[s]).forEach(p.initTexture)},[p,s]),we(e)){const a=Object.keys(e),o={};return a.forEach(n=>Object.assign(o,{[n]:s[a.indexOf(n)]})),o}else return s}T.preload=e=>de.preload(ee,e);T.clear=e=>de.clear(ee,e);F.func.isRequired,F.arrayOf(F.oneOfType([F.element,F.func])).isRequired;const Me=new V,je=new V,Q=[],L=new st;class ns extends et{constructor(){super(),this.color=new ze("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var t;return(t=this.instance.current)==null?void 0:t.geometry}raycast(t,p){const s=this.instance.current;if(!s||!s.geometry||!s.material)return;L.geometry=s.geometry;const a=s.matrixWorld,o=s.userData.instances.indexOf(this.instanceKey);if(!(o===-1||o>s.count)){s.getMatrixAt(o,Me),je.multiplyMatrices(a,Me),L.matrixWorld=je,s.material instanceof tt?L.material.side=s.material.side:L.material.side=s.material[0].side,L.raycast(t,Q);for(let n=0,u=Q.length;n<u;n++){const l=Q[n];l.instanceId=o,l.object=this,p.push(l)}Q.length=0}}}const Fe=c.createContext(null),ve=new V,_e=new V,os=new V,Ce=new S,Pe=new J,Ie=new S,Le=c.forwardRef(({context:e,children:t,...p},s)=>{c.useMemo(()=>jt({PositionMesh:ns}),[]);const a=c.useRef(),{subscribe:o,getParent:n}=c.useContext(e||Fe);return c.useLayoutEffect(()=>o(a),[]),c.createElement("positionMesh",ce({instance:n(),instanceKey:a,ref:Oe([s,a])},p),t)}),rs=c.forwardRef(({children:e,range:t,limit:p=1e3,frames:s=1/0,...a},o)=>{const[{context:n,instance:u}]=c.useState(()=>{const b=c.createContext(null);return{context:b,instance:c.forwardRef((M,v)=>c.createElement(Le,ce({context:b},M,{ref:v})))}}),l=c.useRef(null),[f,h]=c.useState([]),[[m,r]]=c.useState(()=>{const b=new Float32Array(p*16);for(let M=0;M<p;M++)os.identity().toArray(b,M*16);return[b,new Float32Array([...new Array(p*3)].map(()=>1))]});c.useEffect(()=>{l.current.instanceMatrix.needsUpdate=!0});let i=0,g=0;C(()=>{if(s===1/0||i<s){l.current.updateMatrix(),l.current.updateMatrixWorld(),ve.copy(l.current.matrixWorld).invert(),g=Math.min(p,t!==void 0?t:p,f.length),l.current.count=g,l.current.instanceMatrix.updateRange.count=g*16,l.current.instanceColor.updateRange.count=g*3;for(let b=0;b<f.length;b++){const M=f[b].current;M.matrixWorld.decompose(Ce,Pe,Ie),_e.compose(Ce,Pe,Ie).premultiply(ve),_e.toArray(m,b*16),l.current.instanceMatrix.needsUpdate=!0,M.color.toArray(r,b*3),l.current.instanceColor.needsUpdate=!0}i++}});const w=c.useMemo(()=>({getParent:()=>l,subscribe:b=>(h(M=>[...M,b]),()=>h(M=>M.filter(v=>v.current!==b.current)))}),[]);return c.createElement("instancedMesh",ce({userData:{instances:f},matrixAutoUpdate:!1,ref:Oe([o,l]),args:[null,null,0],raycast:()=>null},a),c.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:m.length/16,array:m,itemSize:16,usage:ye}),c.createElement("instancedBufferAttribute",{attach:"instanceColor",count:r.length/3,array:r,itemSize:3,usage:ye}),typeof e=="function"?c.createElement(n.Provider,{value:w},e(u)):c.createElement(Fe.Provider,{value:w},e))}),is=(e,t,p,s,a)=>{const o=new ot,n=1e-5;o.absarc(n,n,n,-Math.PI/2,-Math.PI,!0),o.absarc(n,t-s*2,n,Math.PI,Math.PI/2,!0),o.absarc(e-s*2,t-s*2,n,Math.PI/2,0,!0),o.absarc(e-s*2,n,n,0,-Math.PI/2,!0);const u=new rt(o,{depth:p-s*2,bevelEnabled:!0,bevelSegments:a,steps:2,bevelSize:s,bevelThickness:s,curveSegments:a});u.center();const l=[],f=u.getAttribute("normal"),h=u.getAttribute("position");for(let m=0;m<h.count;m+=1){const r=new S(f.getX(m),f.getY(m),f.getZ(m)),i=new S(h.getX(m),h.getY(m),h.getZ(m));let g=0,w=0;Math.abs(r.y)>.9?(g=i.x/e+.5,w=1-(i.z/p+.5)):Math.abs(r.x)>.9?(g=-i.z/p+.5,w=1-(-i.y/t+.5)):Math.abs(r.z)>.9&&(g=i.x/e+.5,w=1-(-i.y/t+.5)),l.push(g,w)}return u.setAttribute("uv",new it(l,2)),u};is(10,10,10,2,10);const le=new nt(10,10,10),Be=e=>e.node_type==="topic"&&(e.scale||1)>5,as=500,cs=800;let B=null;const ls=500,me=(e,t)=>{if(B)return null;B=setTimeout(()=>{B&&(clearTimeout(B),B=null)},ls);const p=[];return e.forEach(a=>{const o=t.position.distanceTo(at.set(a.x,a.y,a.z));o<cs&&p.push({id:a.ref_id||"",distance:o})}),p.sort((a,o)=>a.distance-o.distance).slice(0,as).map(a=>a.id)},I=new S(5e3,600,1600),Ee=100,us=600,ds=2e3,re={x:172.7392402058252,y:-239.04675366094037,z:-2e3};let R,H;const ps=4e3,fs=2e3,ms=e=>{const t=_(),p=x(y=>y.cameraFocusTrigger),s=E(y=>y.isUserDragging),a=E(y=>y.isUserScrolling),o=E(y=>y.setUserMovedCamera),n=x(y=>y.setNearbyNodeIds),u=x(y=>y.showSelectionGraph),l=x(y=>y.data),f=x(y=>y.graphStyle),{camera:h}=ue(),[m,r]=c.useState(!1),[i,g]=c.useState(!1),[w,b]=c.useState(Ee),M=c.useMemo(()=>{if(u)return new S(0,0,0);const y=l==null?void 0:l.nodes.find(A=>A.ref_id===(t==null?void 0:t.ref_id));let j=new S(2e3,2e3,3e3);if(y&&l){const A=l==null?void 0:l.nodes.filter(N=>{var xe;return(xe=y.children)==null?void 0:xe.find(De=>De===N.id)}),$=new S(y.x,y.y,y.z);let ne=new S(0,0,0);A.map(N=>(ne=ne.add(new S(N.x,N.y,N.z).normalize()),N));const Ze=y.scale?1-1/(y.scale+10):1,Je=$.sub(ne).multiplyScalar(.8*Ze);j=$.add(Je)}return j},[u,t,l]),v=c.useMemo(()=>{if(u)return new S(0,0,0);const y=l==null?void 0:l.nodes.find(j=>j.ref_id===(t==null?void 0:t.ref_id));return new S((y==null?void 0:y.x)||0,(y==null?void 0:y.y)||0,(y==null?void 0:y.z)||0)},[u,t,l]);c.useEffect(()=>{var y;u&&((y=e.current)==null||y.setLookAt(re.x,re.y,re.z,0,0,0,!1)),se()},[u]),c.useEffect(()=>{u?b(ds):(t==null?void 0:t.node_type)==="topic"?b(us):b(Ee)},[t,b,u]),c.useEffect(()=>{k()},[p]),c.useEffect(()=>{(s||a)&&(r(!0),g(!0))},[s,a,r,g]),c.useEffect(()=>{if(t)if(!u&&f==="earth"&&(e!=null&&e.current)){const y=e.current.camera.position.distanceTo(new S),j=ct(v,-y/2);e.current.setLookAt(j.x,j.y,j.z,0,0,0,!0)}else R&&clearTimeout(R),R=setTimeout(()=>{g(!0),clearTimeout(R)},fs),se();return()=>{R&&clearTimeout(R),H&&clearTimeout(H)}},[t]),C(y=>{e.current&&(m||K(M,y.camera),i||U(v,y.camera))});const se=()=>{if(t){const y=h.position.distanceTo(M);Et(y)}k()},k=()=>{r(!1),g(!1),o(!1),H&&clearTimeout(H),H=setTimeout(()=>{r(!0),g(!0)},ps)},K=(y,j)=>{if(j.position.distanceTo(y)<w)r(!0);else{j.position.lerp(y,.5);const $=me((l==null?void 0:l.nodes)||[],h);$&&n($)}},U=(y,j)=>{var A;(A=e==null?void 0:e.current)==null||A.setLookAt(j.position.x,j.position.y,j.position.z,y.x,y.y,y.z,!0)};return null},hs=1;let P=null;const gs=(e,{enabled:t})=>{const p=_();ms(e);const s=E(h=>h.isUserDragging),a=x(h=>h.disableCameraRotation),o=x(h=>h.data),n=x(h=>h.graphStyle),u=x(h=>h.graphRadius),l=x(h=>h.setNearbyNodeIds);c.useEffect(()=>{t||(P==null||P.kill(),P=null)},[t]);const f=c.useCallback(()=>{P==null||P.kill();const h={value:-244},m=At.to(h,{duration:5,keyframes:{"0%":{value:10},"100%":{delay:2,ease:"Power4.easeIn",value:-200}},onComplete:()=>{P=null},onInterrupt(){m.kill()},onUpdate:()=>{var i;const{value:r}=h;if(e.current){const g=me((o==null?void 0:o.nodes)||[],e.current.camera);g&&l(g),(i=e.current)==null||i.dolly(r,!1)}}});m.play(),P=m},[]);return c.useEffect(()=>{e.current&&u&&(n==="sphere"?(e.current.maxDistance=8e3,e.current.minDistance=200,e.current.setTarget(0,0,500,!0)):(e.current.maxDistance=e.current.getDistanceToFitSphere(u+200),e.current.minDistance=100))},[u,n,e]),c.useEffect(()=>{f()},[f,n]),c.useEffect(()=>{!p&&e.current&&e.current.setLookAt(I.x,I.y,I.z,0,0,0,!0)},[p]),C((h,m)=>{e.current&&(!a&&!s&&(e.current.azimuthAngle+=hs*m*lt.DEG2RAD),e.current.update(m))}),null},xs=({disableAnimations:e})=>{const t=c.useRef(null),p=x(r=>r.graphStyle),s=x(r=>r.data),a=x(r=>r.setNearbyNodeIds),o=x(r=>r.setDisableCameraRotation),[n]=c.useState(.8),{camera:u}=ue(),[l,f,h,m]=E(r=>[r.isUserDragging,r.setIsUserDragging,r.isUserScrolling,r.isUserScrollingOnHtmlPanel]);return gs(t,{enabled:!e&&!h&&!l}),c.useEffect(()=>{t.current&&t.current.setLookAt(I.x,I.y,I.z,0,0,0,!0)},[p]),c.useEffect(()=>{if(!l){const r=me((s==null?void 0:s.nodes)||[],u);r&&a(r)}},[u,u.position,u.position.x,u.position.y,u.position.z,s==null?void 0:s.nodes,a,l]),c.useEffect(()=>{l&&o(!0)},[l,o]),d.jsx(Tt,{ref:t,boundaryEnclosesCamera:!0,enabled:!m,makeDefault:!0,maxDistance:12e3,minDistance:100,onEnd:()=>f(!1),onStart:()=>f(!0),smoothTime:n})},te={metalness:.9,roughness:0},ys={...te},bs=new q(ys),Ss=({hide:e})=>{const t=$e(),p=x(a=>a.graphStyle),s=c.useMemo(()=>t.nodes.map((a,o)=>{if(a.node_type==="topic")return!1;const n=!Be(a),u=pe(a.node_type||"",!0);return d.jsx(Le,{color:u,name:a.id,position:[a.x,a.y,a.z],scale:n?(a.scale||1)*.9:0,userData:a},`${a.ref_id||a.id}-instanced-node-${o}-${p}`)}),[p,t]);return d.jsx(rs,{geometry:le,material:bs,visible:!e,children:s})},He=new ee,D=He.load("noimage.jpeg"),Ae=new q({...te,map:D}),We=.4,ws=new q({...te,map:D,transparent:!0,opacity:We}),X={},Ms=(e,t)=>{const[p,s]=c.useState(D),[a,o]=c.useState(Ae);return c.useEffect(()=>{const n=`${e}${t&&"-transparent"}`;if(X[n]){s(X[n].texture),o(X[n].material);return}He.load(e,u=>{const l=new q({map:u,transparent:t,opacity:t?We:1,...te});X[n]={texture:u,material:l},s(u),o(l)},void 0,()=>{s(D),o(t?ws:Ae)})},[e,t]),c.useEffect(()=>function(){p.dispose(),a.dispose()},[p,a]),a},he=c.memo(({node:e,hide:t,animated:p})=>{const s=c.useRef(null),[a]=c.useState(le),o=_(),n=x(h=>h.showSelectionGraph),u=!!o&&e.ref_id===o.ref_id,l=Ms(e.image_url||"noimage.jpeg",!1);C((h,m)=>{p&&s.current&&(s.current.position.set(e.x,e.y,e.z),u&&(s.current.rotation.y+=m*1,s.current.rotation.x-=m*.6))}),c.useEffect(()=>function(){a.dispose()},[a]);const f=c.useMemo(()=>n&&u?20:u?(e.scale||1)*1.2:e.scale,[e,u,n]);return d.jsx(zt,{enabled:!!u,children:d.jsx("mesh",{ref:s,geometry:le,material:l,name:e.id,position:[e.x,e.y,e.z],scale:f,userData:e,visible:!t})})});he.displayName="Cube";const js=z(ke)`
  text-align: center;
  width: ${e=>e.type==="topic"?"auto":`${e.size}px`};
  height: ${e=>e.type==="topic"?"auto":`${e.size}px`};
  outline: 1px solid ${e=>O.white||e.color};
  outline-offset: 0px;
  background: rgba(0, 0, 0, 0.75);
  color: ${e=>e.fontColor};
  border-radius: ${e=>`${e.type==="guest"?"100%":"6px"}`};
  font-size: ${e=>`${e.fontSize}px`};
  cursor: pointer;
  transition: font-size 0.4s, outline 0.4s;
  transform: scale(${e=>e.scale});
  align-items: center;
  justify-content: center;
  font-family: Barlow;
  font-size: 26px;
  font-style: normal;
  font-weight: 700;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);

  &:hover {
    outline-offset: 4px;
  }

  &.selected {
    .badge-wrapper {
      top: 0;
    }

    font-size: 36px;

    &:hover {
      outline-offset: 0px;
    }
  }

  &.topic {
    outline: none;
    background: none;
    &:hover {
      font-size: 36px;
    }
    white-space: nowrap;
    .badge-wrapper {
      display: none;
    }
  }

  .badge-wrapper {
    position: absolute;
    top: -7px;
    left: -14px;
  }
`;z.img`
  background-image: ${({src:e})=>`url(${e})`};
  background-size: contain;
  background-repeat: no-repeat;
  width: ${e=>e.size}px;
  height: ${e=>e.size}px;
  border-radius: ${e=>e.borderRadius};
`;z.div`
  display: flex;
  position: absolute;
  bottom: -14px;
  left: -5px;
  width: auto;
  justify-content: center;
  align-items: center;
`;z.div`
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${O.transparentBlack};
  border: 2px solid ${e=>e.color};
  color: #fff;
  padding: 0 4px;
  min-width: 30px;
  height: 26px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  margin-right: 5px;
`;z.div`
  display: flex;
  justify-content: center;
  align-items: center;
  border: 2px solid ${e=>e.color}44;
  background: ${O.transparentBlack};
  padding: 0 4px;
  color: ${e=>e.color};
  min-width: 30px;
  height: 26px;
  font-size: 12px;
  font-weight: 500;
  border-radius: 6px;
  margin-right: 5px;
`;const vs=new S,_s=({position:e,userData:t,color:p})=>{const s=c.useRef(null),[a,o]=x(i=>[i.selectedNode,i.setSelectedNode]),n=x(i=>i.setHoveredNode),u=x(i=>i.hoveredNode),l=x(i=>i.showSelectionGraph),f=((t==null?void 0:t.node_type)||"")==="topic",h=((t==null?void 0:t.node_type)||"")==="guest"||((t==null?void 0:t.node_type)||"")==="person";C(()=>{if(l&&s.current){const i=vs.set((t==null?void 0:t.x)||0,(t==null?void 0:t.y)||0,(t==null?void 0:t.z)||0);s.current.position.copy(i)}}),c.useEffect(()=>function(){s.current&&s.current.clear()},[s]);const m=c.useMemo(()=>(u==null?void 0:u.ref_id)===(t==null?void 0:t.ref_id),[u==null?void 0:u.ref_id,t==null?void 0:t.ref_id]),r=(a==null?void 0:a.ref_id)===(t==null?void 0:t.ref_id);return f||r&&l||!r?d.jsx("group",{ref:s,position:e,children:d.jsx(fe,{center:!0,sprite:!0,zIndexRange:[0,0],children:d.jsxs(js,{className:dt(t==null?void 0:t.node_type,{selected:r}),color:p,fontColor:O.white,fontSize:f?64:20,onClick:i=>{i.stopPropagation(),t&&o(t)},onPointerOut:i=>{i.stopPropagation(),n(null)},onPointerOver:i=>{i.stopPropagation(),n(t||null)},scale:m?1.05:1,selected:!1,size:r?100:68,type:(t==null?void 0:t.node_type)||"",children:[!h&&!f?d.jsx("div",{className:"badge-wrapper",children:d.jsx(Zt,{type:(t==null?void 0:t.node_type)||""})}):null,f?t==null?void 0:t.label:d.jsx(qt,{rounded:h,size:r?60:52,src:(t==null?void 0:t.image_url)||"audio_default.svg",type:t==null?void 0:t.node_type})]})})}):null},Ve=c.memo(()=>{const e=x(n=>n.data),t=_(),p=x(n=>n.showSelectionGraph),s=x(n=>n.selectionGraphData),a=x(n=>n.selectedNodeRelativeIds),o=c.useMemo(()=>(p?s.nodes:(e==null?void 0:e.nodes)||[]).filter(f=>a.includes((f==null?void 0:f.ref_id)||"")||(t==null?void 0:t.ref_id)===(f==null?void 0:f.ref_id)).slice(0,Ne).map(f=>{const h=pe(f.node_type||"",!0),m=new S((f==null?void 0:f.x)||0,(f==null?void 0:f.y)||0,(f==null?void 0:f.z)||0),r=((e==null?void 0:e.nodes)||[]).filter(i=>i.ref_id&&ut(i,f)).map(i=>(i==null?void 0:i.ref_id)||"")||[];return d.jsx(_s,{color:h,position:m,relativeIds:r,userData:f},`node-badge-${f.ref_id}`)}),[a,e==null?void 0:e.nodes,p,s,t]);return d.jsx(c.Fragment,{children:o.length?o:null},"node-badges")});Ve.displayName="RelevanceBadges";const qe=({link:e,animated:t})=>{const p=c.useRef(null),s=_(),[a,o]=c.useState(new S(0,0,0)),[n,u]=c.useState(new S(0,0,0)),[l,f]=c.useState(8947848),h=x(m=>m.selectionGraphData);return c.useEffect(()=>{var i,g,w,b,M,v;const m=(s==null?void 0:s.ref_id)||"",r=s&&(m===e.targetRef||m===e.sourceRef);!e.onlyVisibleOnSelect||r?(o(new S(((i=e.sourcePosition)==null?void 0:i.x)||0,((g=e.sourcePosition)==null?void 0:g.y)||0,((w=e.sourcePosition)==null?void 0:w.z)||0)),u(new S(((b=e.targetPosition)==null?void 0:b.x)||0,((M=e.targetPosition)==null?void 0:M.y)||0,((v=e.targetPosition)==null?void 0:v.z)||0))):(o(new S(0,0,0)),u(new S(0,0,0))),f(r?e.color||Re.children.segmentColor:s?5592405:8947848)},[s,e]),C(()=>{if(t&&p.current){const m=h.nodes.find(i=>i.ref_id===e.sourceRef),r=h.nodes.find(i=>i.ref_id===e.targetRef);p.current.start.set((m==null?void 0:m.x)||0,(m==null?void 0:m.y)||0,(m==null?void 0:m.z)||0),p.current.end.set((r==null?void 0:r.x)||0,(r==null?void 0:r.y)||0,(r==null?void 0:r.z)||0)}}),d.jsx(kt,{ref:p,color:"0xFFFFFF",end:n,start:a})},ge=c.memo(({node:e,hide:t})=>{const p=c.useRef(null),s=_(),o=x(h=>h.selectedNodeRelativeIds).includes((e==null?void 0:e.ref_id)||""),n=!!s&&(s==null?void 0:s.id)===e.id,u=x(h=>h.showSelectionGraph);C(({camera:h})=>{p!=null&&p.current&&(p.current.quaternion.copy(h.quaternion),u&&p.current.position.set(e.x,e.y,e.z))});const l=c.useMemo(()=>{let h=(e.scale||1)*4;return u&&n?h=40:!n&&o&&(h=0),h},[e.scale,n,o,u]),f=c.useMemo(()=>s&&s.node_type==="topic"&&!n?.2:1,[n,s]);return d.jsx(vt,{ref:p,anchorX:"center",anchorY:"middle",color:O.white,fillOpacity:f,position:[e.x,e.y,e.z],scale:l,userData:e,visible:!t&&!n,...Qt,children:e.label})});ge.displayName="TextNode";let ie=null;const Ke=c.memo(()=>{const e=$e(),t=_(),p=x(o=>o.selectedNodeRelativeIds),s=x(o=>o.selectionGraphData),a=x(o=>o.setSelectionData);return c.useEffect(()=>{const o=e.nodes.filter(u=>u.ref_id===(t==null?void 0:t.ref_id)||p.includes((u==null?void 0:u.ref_id)||"")).map(u=>{const l=u.ref_id===(t==null?void 0:t.ref_id)&&u.node_type!=="topic"?{fx:0,fy:0,fz:0}:{};return{...u,x:0,y:0,z:0,...l}}),n=pt(o,!1,!1);a({nodes:o,links:n})},[e,t,p,a]),c.useEffect(()=>{ie=ft(s.nodes,s.links,{numDimensions:2,forceLinkStrength:.01,forceCenterStrength:.85,forceChargeStrength:-20,velocityDecay:.9})},[s]),C(()=>{ie&&ie.tick()}),d.jsxs(d.Fragment,{children:[s==null?void 0:s.nodes.map(o=>o.node_type==="topic"?d.jsx(ge,{hide:!0,node:o},`${o.ref_id||o.id}-compact`):d.jsx(he,{animated:!0,hide:!0,node:o},`${o.ref_id||o.id}-compact`)),d.jsx(Ue,{fog:!0,lineWidth:.9,children:(s==null?void 0:s.links).map((o,n)=>d.jsx(qe,{animated:!0,link:o},n.toString()))},`selection-links-${s==null?void 0:s.links.length}`)]})});Ke.displayName="SelectionDataNodes";const Qe=c.memo(()=>{const e=mt(),t=_(),p=x(r=>r.nearbyNodeIds),s=x(r=>r.setHoveredNode),a=x(r=>r.showSelectionGraph),o=x(r=>r.selectionGraphData),n=Ge(r=>r.setTranscriptOpen),u=c.useCallback(r=>!!(a&&!o.nodes.find(i=>i.ref_id===r.ref_id)),[a,o]),l=c.useCallback(r=>{const i=r==null?void 0:r[0];i&&(n(!1),i.userData&&(u(i.userData)||x.getState().setSelectedNode((i==null?void 0:i.userData)||null)))},[n,u]),f=c.useCallback(r=>{r.stopPropagation(),s(null)},[s]),h=c.useCallback(r=>{var w;const g=r.intersections.map(b=>b.object)[0];if((w=g==null?void 0:g.userData)!=null&&w.ref_id){const b=g.userData;u(b)||(r.stopPropagation(),s(b))}},[s,u]),m=a&&!!t;return d.jsxs(Nt,{filter:r=>r.filter(i=>{var g;return!!((g=i.userData)!=null&&g.id)}),onChange:l,onPointerOut:f,onPointerOver:h,children:[d.jsx(Ss,{hide:m}),d.jsx(Ve,{}),e==null?void 0:e.nodes.filter(r=>{const i=(r==null?void 0:r.ref_id)===(t==null?void 0:t.ref_id);return p.includes(r.ref_id||"")||Be(r)||i}).map(r=>r.node_type==="topic"?d.jsx(ge,{hide:m,node:r},r.ref_id||r.id):d.jsx(he,{hide:m,node:r},r.ref_id||r.id)),m&&d.jsx(Ke,{})]})});Qe.displayName="Cubes";const Cs={earthRef:null},Ps=ht(e=>({...Cs,setEarthRef:t=>e({earthRef:t})})),Is=(e,t)=>{const p=new J().setFromUnitVectors(new S(0,1,0),e.clone().normalize()),s=new J().setFromUnitVectors(new S(0,1,0),t.clone().normalize()),a=new J,o=50,n=[];for(let l=0;l<=o;l+=1){const f=l/o;a.slerpQuaternions(p,s,f);const h=new S(0,1,0).applyQuaternion(a).multiplyScalar(W+gt);n.push(h)}return new xt(n).getPoints(o)},Es=({link:e})=>{const t=_(),[p,s]=c.useState(8947848);c.useEffect(()=>{const o=(t==null?void 0:t.ref_id)||"",n=t&&(o===e.targetRef||o===e.sourceRef);s(n?e.color||Re.children.segmentColor:t?5592405:8947848)},[t,e]);const a=c.useMemo(()=>{var f,h,m,r,i,g;const o=(t==null?void 0:t.ref_id)||"",n=t&&(o===e.targetRef||o===e.sourceRef);if(!(!e.onlyVisibleOnSelect||n))return[];const u=new S(((f=e.sourcePosition)==null?void 0:f.x)||0,((h=e.sourcePosition)==null?void 0:h.y)||0,((m=e.sourcePosition)==null?void 0:m.z)||0),l=new S(((r=e.targetPosition)==null?void 0:r.x)||0,((i=e.targetPosition)==null?void 0:i.y)||0,((g=e.targetPosition)==null?void 0:g.z)||0);return Is(u,l)},[e,t]);return a.length?d.jsx(_t,{color:p,dashed:!1,lineWidth:3,points:a}):null},As=new S(0,0,0),Ts=()=>{const e=c.useRef(null),t=c.useRef(null),p=x(l=>l.graphStyle),s=x(l=>l.showSelectionGraph),a=x(l=>l.data),o=Ps(l=>l.setEarthRef),n=T("textures/earth/galaxy.png"),u=T("textures/earth/clouds.png");return C(({camera:l})=>{t.current&&t.current.position.copy(l.getWorldPosition(As))}),c.useLayoutEffect(()=>{e.current&&o(e)},[o]),p!=="earth"||s?null:d.jsxs(d.Fragment,{children:[d.jsxs("mesh",{ref:e,userData:{type:"earth"},children:[d.jsx("sphereGeometry",{args:[W,200,200]}),d.jsx(zs,{})]}),d.jsxs("mesh",{children:[d.jsx("sphereGeometry",{args:[W+2,200,200]}),d.jsx("meshStandardMaterial",{alphaMap:u,map:u,transparent:!0})]}),d.jsxs("mesh",{children:[d.jsx("sphereGeometry",{args:[W*4,200,200]}),d.jsx("meshStandardMaterial",{map:n,opacity:.4,side:yt,transparent:!0})]}),d.jsx("directionalLight",{ref:t,intensity:.9,position:[0,0,W*3]}),a==null?void 0:a.links.map((l,f)=>d.jsx(Es,{link:l},`curved-${f}`))]})},zs=()=>{const e=T("textures/earth/earth.jpeg"),t=T("textures/earth/bump.jpeg"),p=T("textures/earth/water.png"),s=c.useMemo(()=>new q({map:e,bumpMap:t,aoMap:t,roughnessMap:t,metalnessMap:p,toneMapped:!0,roughness:35,metalness:0}),[e,t,p]);return d.jsx("meshStandardMaterial",{...s})},G=2e3,Y=Pt*4,Te=Object.values(Ct).map(e=>e),ks=()=>{const e=c.useRef(null);C(()=>{var n,u,l,f,h;const a=(u=(n=e.current)==null?void 0:n.geometry.getAttribute("position"))==null?void 0:u.array,o=(f=(l=e.current)==null?void 0:l.geometry.getAttribute("velocity"))==null?void 0:f.array;if(a&&o){for(let m=0;m<a.length;m+=3){const r=a[m],i=a[m+1],g=a[m+2],w=o[m],b=o[m+1],M=o[m+2];a[m]+=w,a[m+1]+=b,a[m+2]+=M;const v=Math.sqrt(r*r+i*i+g*g);if(v*v>Y*Y){const k=Math.random()*Math.PI*2,K=Math.random()*Math.PI*2,U=Math.random()*Y;a[m]=Math.sin(k)*Math.cos(K)*U,a[m+1]=Math.sin(k)*Math.sin(K)*U,a[m+2]=Math.cos(k)*U}}((h=e.current)==null?void 0:h.geometry.getAttribute("position")).needsUpdate=!0}});const t=c.useMemo(()=>new Float32Array(G*3),[]),p=c.useMemo(()=>new Float32Array(G*3),[]);c.useEffect(()=>{const a=Y;for(let o=0;o<G;o+=1){const n=o*3,u=Math.acos(1-o/G*2),l=Math.PI*2*o/G;t[n]=Math.sin(u)*Math.cos(l)*a,t[n+1]=Math.sin(u)*Math.sin(l)*a,t[n+2]=Math.cos(u)*a,p[n]=Math.random()-.5,p[n+1]=Math.random()-.5,p[n+2]=Math.random()-.5}},[t,p]);const s=c.useRef(null);return c.useEffect(()=>{s.current&&e.current&&(s.current.setAttribute("position",new oe(t,3)),s.current.setAttribute("velocity",new oe(p,3)),e.current.geometry=s.current)},[t,p]),c.useEffect(()=>{if(s.current){const a=[];for(let o=0;o<G;o+=1){const n=Math.floor(Math.random()*Te.length),u=Te[n],l=new ze(u);l.multiplyScalar(2),a.push(l.r,l.g,l.b)}s.current.setAttribute("color",new oe(new Float32Array(a),3))}},[]),d.jsxs("points",{ref:e,frustumCulled:!1,children:[d.jsx("bufferGeometry",{ref:s}),d.jsx("pointsMaterial",{opacity:.8,size:4,transparent:!0,vertexColors:!0})]})},Z=e=>({close:{backgroundColor:"rgba(48, 51, 66, 1)",borderColor:"#fff",fontColor:"rgba(255, 255, 255, 1)"},focus:{backgroundColor:e?"rgba(255, 255, 255, 0.90);":"rgba(255, 255, 255, 0.90)",borderColor:e?"#FFDB58bb":"#fff",fontColor:"rgba(48, 51, 66, 1)"},menu:{backgroundColor:"#00000066",borderColor:e?"#ffffff66":"#5078f2",fontColor:e?"#ffffff66":"#fff"}}),Ns=new S,Xe=c.memo(()=>{const e=c.useRef(null),t=Ge(i=>i.setSidebarOpen),{open:p}=be("editNodeName"),{open:s}=be("addEdgeToNode"),[a]=bt(i=>[i.isAdmin]),o=x(i=>i.showSelectionGraph),n=x(i=>i.selectionGraphData),u=x(i=>i.data),l=_(),f=x(i=>i.setSelectedNode),h=x(i=>i.setShowSelectionGraph);C(()=>{m()});const m=c.useCallback(()=>{const i=o?n:u;if(e.current){const g=i==null?void 0:i.nodes.find(w=>w.ref_id===(l==null?void 0:l.ref_id));if(g){const w=Ns.set(g==null?void 0:g.x,g==null?void 0:g.y,g==null?void 0:g.z);e.current.position.copy(w)}}},[l,o,n,u]),r=c.useMemo(()=>{const i=a?[{key:"control-key-1",colors:Z(o).focus,icon:d.jsx(es,{}),left:-80,className:"add",onClick:()=>{s()}},{key:"control-key-2",colors:Z(o).focus,icon:d.jsx(Rt,{}),left:-40,className:"edit",onClick:()=>{p()}}]:[],g=[{key:"control-key-4",colors:Z(o).focus,icon:d.jsx(Jt,{}),left:0,className:"expand",onClick:()=>{const w=!o;h(w),w&&t(!0)}},{key:"control-key-5",colors:Z(!0).close,icon:d.jsx(Dt,{}),left:40,className:"exit",onClick:()=>{f(null),h(!1)}}];return[...i,...g].map((w,b)=>({...w,left:-80+b*40}))},[o,s,p,h,t,f,a]);return l?d.jsx("group",{ref:e,children:d.jsx(fe,{center:!0,className:"control-panel",onClick:i=>i.stopPropagation(),onKeyDown:i=>i.stopPropagation(),onPointerDown:i=>i.stopPropagation(),onPointerOut:i=>i.stopPropagation(),onPointerOver:i=>i.stopPropagation(),onPointerUp:i=>i.stopPropagation(),sprite:!0,zIndexRange:[16777271,16777272],children:r.map(i=>d.jsx(Rs,{backgroundColor:i.colors.backgroundColor,borderColor:i.colors.borderColor,className:i.className,fontColor:i.colors.fontColor,left:i.left,onClick:g=>{g.stopPropagation(),i.onClick()},children:i.icon},i.key))})}):null});Xe.displayName="NodeControls";const Rs=z.div`
  position: fixed;
  top: -60px;
  left: ${e=>-7+e.left}px;
  width: 24px;
  height: 24px;

  border-radius: 40px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: ${e=>e.backgroundColor?e.backgroundColor:"#000000bb"};
  color: ${e=>e.fontColor?e.fontColor:"#ffffff"};
  border-radius: 100%;
  font-size: 16px;
  cursor: pointer;
  transition: opacity 0.4s;
  box-shadow: 0px 2px 12px rgba(0, 0, 0, 0.5);
`,Ye=c.memo(()=>d.jsx(d.Fragment,{children:d.jsx(Xe,{})}));Ye.displayName="NodeDetailsPanel";const Gs=()=>{const e=x(f=>f.data),t=x(f=>f.isFetching),p=x(f=>f.graphStyle),s=x(f=>f.showSelectionGraph),a=x(f=>f.selectedNodeRelativeIds),o=x(f=>f.selectionGraphData),n=x(f=>f.selectedNode),u=c.useMemo(()=>s?0:p==="force"?.2:.4,[s,p]),l=c.useMemo(()=>(s?o.nodes:(e==null?void 0:e.nodes)||[]).filter(r=>a.includes((r==null?void 0:r.ref_id)||"")||(n==null?void 0:n.ref_id)===(r==null?void 0:r.ref_id)).slice(0,Ne).map(r=>{const i=new S(n==null?void 0:n.x,n==null?void 0:n.y,n==null?void 0:n.z),g=new S(r.x,r.y,r.z),w={source:n!=null&&n.id?n.id:"",target:r.id?r.id:"",targetRef:r.ref_id,sourceRef:n==null?void 0:n.ref_id,sourcePosition:i,targetPosition:g};return d.jsx(qe,{link:w},r.id)}),[a,e==null?void 0:e.nodes,s,o,n]);return t?null:d.jsxs(d.Fragment,{children:[d.jsx(Qe,{}),d.jsx(Ts,{}),d.jsx(ks,{}),p!=="earth"&&d.jsx(Ue,{fog:!0,limit:l.length,lineWidth:u,children:l},`links-${l.length}-${p}`),d.jsx(Ye,{})]})},Os=()=>d.jsx(fe,{children:d.jsx($t,{})}),Us=()=>{const{universeColor:e}=Kt("universe",{universeColor:O.black}),t=_(),p=c.useMemo(()=>t!=null&&t.node_type?pe(t.node_type):Mt,[t]);return d.jsxs(d.Fragment,{children:[d.jsx("color",{args:[e],attach:"background"}),d.jsx(Yt,{}),d.jsx(xs,{}),d.jsxs(Ft,{children:[d.jsxs(Lt,{autoClear:!1,multisampling:8,children:[d.jsx(Bt,{darkness:.7,eskil:!1,offset:.05}),d.jsx(Ht,{luminanceThreshold:1,mipmapBlur:!0,resolutionX:Se.AUTO_SIZE,resolutionY:Se.AUTO_SIZE}),d.jsx(Wt,{blendFunction:Vt.SCREEN,blur:!0,edgeStrength:4,hiddenEdgeColor:p,visibleEdgeColor:p})]}),d.jsx(Gs,{})]})]})};let ae=null;const $s={aspect:window.innerWidth/window.innerHeight,far:3e4,near:1,position:[I.x,I.y,I.z]},Fs=()=>{const[e,t,p]=[E(n=>n.setIsUserScrollingOnHtmlPanel),E(n=>n.setIsUserScrolling),E(n=>n.setUserMovedCamera)],s=x(n=>n.isFetching),a=c.useCallback(n=>{var f;const{target:u}=n,{offsetParent:l}=u;ae&&clearTimeout(ae),(f=l==null?void 0:l.classList)!=null&&f.contains("html-panel")&&l.clientHeight<l.scrollHeight&&e(!0),t(!0),p(!0),ae=setTimeout(()=>{t(!1),e(!1)},200)},[t,e,p]),o=c.useCallback(n=>St(n,"threeState"),[]);return d.jsxs(Ls,{children:[d.jsx(c.Suspense,{fallback:null,children:d.jsxs(It,{camera:$s,id:"universe-canvas",onCreated:o,onWheel:a,children:[wt&&d.jsx(Xt,{position:"top-right"}),d.jsxs(c.Suspense,{fallback:d.jsx(Os,{}),children:[d.jsx(Gt,{}),d.jsx(Ot,{}),d.jsx(Ut,{}),d.jsx(Us,{})]})]})}),s&&d.jsx(ts,{fullSize:!1}),d.jsx(ss,{})]})},Ls=z(ke)`
  flex: 1 1 100%;
  position: relative;
`,un=c.memo(Fs);export{un as Universe};
